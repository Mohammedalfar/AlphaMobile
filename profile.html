<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alpha Mobile • Profile</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root{ --pistachio: #93C572; --bg: #fbfefb; --text: #0f172a; --card: #ffffff; --muted: #64748b; --border: rgba(0,0,0,0.08); }
    [data-theme="dark"]{ --bg: #0a0e17; --card: #111827; --text: #f8fafc; --muted: #94a3b8; --border: rgba(255,255,255,0.1); }
    
    body{ font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); margin:0; padding:20px; display:flex; justify-content:center; align-items: flex-start; min-height: 100vh; box-sizing: border-box; }
    
    .profile-container { width:100%; max-width:500px; margin-top:60px; animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
    
    .user-card { background: var(--card); border: 1px solid var(--border); border-radius: 32px; padding: 40px; text-align: center; position: relative; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.05); }
    
    .avatar { width: 100px; height: 100px; background: linear-gradient(135deg, var(--pistachio), #A8D5A2); border-radius: 50%; margin: 0 auto 20px; display: grid; place-items: center; font-size: 40px; color: white; font-weight: 900; box-shadow: 0 10px 20px rgba(147, 197, 114, 0.3); }
    
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px; }
    .stat-box { background: var(--bg); padding: 20px; border-radius: 20px; border: 1px solid var(--border); transition: transform 0.2s; }
    .stat-box:hover { transform: translateY(-2px); border-color: var(--pistachio); }
    
    .stat-val { font-size: 24px; font-weight: 900; color: var(--text); }
    .stat-lbl { font-size: 11px; color: var(--muted); font-weight: 700; text-transform: uppercase; margin-top: 5px; letter-spacing: 0.5px; }

    .btn-logout { background: #ef4444; color: white; padding: 14px 24px; border-radius: 99px; border: none; font-weight: 700; cursor: pointer; margin-top: 30px; width: 100%; font-size: 16px; transition: 0.2s; }
    .btn-logout:hover { opacity: 0.9; transform: scale(1.02); }
    
    .btn-home { display: block; width: 100%; text-align: center; background: transparent; color: var(--text); border: 1px solid var(--border); padding: 14px 24px; border-radius: 99px; font-weight: 700; cursor: pointer; margin-top: 10px; text-decoration: none; box-sizing: border-box; transition: 0.2s; }
    .btn-home:hover { background: var(--bg); border-color: var(--text); }
    
    .loader { margin-top: 0; color: var(--muted); font-weight: 600; display: flex; flex-direction: column; gap: 10px; align-items: center; justify-content: center; height: 300px; }
    
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

  <div class="profile-container">
    <div class="user-card">
      
      <div id="loader" class="loader">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        <span>Accessing Database...</span>
      </div>
      
      <div id="content" style="display:none;">
        <div class="avatar" id="p-initial">A</div>
        <h1 id="p-name" style="margin:0; font-size: 28px;">...</h1>
        <p id="p-email" style="color:var(--muted); margin-top:5px; font-size: 14px;">...</p>
        <p id="p-phone" style="color:var(--muted); margin:2px 0 0; font-size: 14px;">...</p>

        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-val" id="s-count">0</div>
            <div class="stat-lbl">Total Orders</div>
          </div>
          <div class="stat-box">
            <div class="stat-val" id="s-spent">€0</div>
            <div class="stat-lbl">Total Spent</div>
          </div>
        </div>

        <button class="btn-logout" id="btn-logout">Sign Out</button>
        <a href="shop.html" class="btn-home">Back to Shop</a>
      </div>

    </div>
  </div>
  
  <style> @keyframes spin { 100% { transform: rotate(360deg); } } </style>

  <script type="module">
    import { subscribeToAuth, getUserProfile, logoutUser } from './db.js';

    // Check Theme
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);

    subscribeToAuth(async (user) => {
      if (!user) {
        // Not logged in -> Redirect to login
        window.location.href = 'login.html';
        return;
      }

      try {
        // Fetch extended data from Firestore
        const profile = await getUserProfile(user.uid);
        
        if(profile) {
          document.getElementById('p-name').innerText = profile.name || "Customer";
          document.getElementById('p-email').innerText = profile.email;
          document.getElementById('p-phone').innerText = profile.phone || "";
          document.getElementById('p-initial').innerText = (profile.name || user.email)[0].toUpperCase();
          document.getElementById('s-count').innerText = profile.ordersCount || 0;
          document.getElementById('s-spent').innerText = "€" + (profile.totalSpent || 0);
        } else {
          // Fallback if firestore doc missing
          document.getElementById('p-name').innerText = "User";
          document.getElementById('p-email').innerText = user.email;
          document.getElementById('p-initial').innerText = user.email[0].toUpperCase();
        }

        // Show Content
        document.getElementById('loader').style.display = 'none';
        document.getElementById('content').style.display = 'block';

      } catch (e) {
        alert("Error fetching profile: " + e.message);
      }
    });

    document.getElementById('btn-logout').onclick = async () => {
      if(confirm("Are you sure you want to sign out?")) {
        await logoutUser();
        window.location.href = 'index.html';
      }
    };
  </script>
</body>
</html>
